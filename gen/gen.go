package main

import (
	"bytes"
	"io/ioutil"
	"log"
	"os"
	"text/template"
)

//go:generate go run gen.go

var templateVar = `// Code generated by gen.go DONT'T EDIT!!!
package generated

import (
    b64 "encoding/base64"
)

type {{.Type}} struct {}

func (v *EncodingService) GetEncodedString(initialString string) string {
	return b64.StdEncoding.EncodeToString([]byte(initialString))
}
`

const (
	TypeKey   = "TYPE"
	OutputKey = "OUTPUT"
)

func main() {
	templateVar, err := template.New("").Parse(templateVar) // create Template struct by custom template schema
	if err != nil {
		log.Fatal(err)
	}
	buffer := &bytes.Buffer{}
	err = templateVar.Execute(buffer, struct { // write into buffer
		Type string
	}{
		Type: os.Getenv(TypeKey), // retrieve type value (specified in Makefile) by TYPE key
	})
	if err != nil {
		log.Fatal(err)
	}
	err = ioutil.WriteFile(os.Getenv(OutputKey), buffer.Bytes(), 0644) // generate data reed from buffer (slice of bytes) in the specified directory
	if err != nil {
		log.Fatal(err)
	}
}
